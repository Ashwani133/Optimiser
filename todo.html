<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OPTIMISER</title>
    <link rel="stylesheet" href="styles.css" />
    <script
      src="https://kit.fontawesome.com/f218339789.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  </head>
  <body>
    <nav></nav>
    <div class="hero">
      <div class="sidebar">
        <div class="personal-info-card">
          <div id="pic"></div>
          <div class="profile-text">
            <div id="profile-name">Ashwani kaushik</div>
            <div id="profile-info">More info</div>
          </div>
        </div>
        <div class="btnDiv">
          <button class="addtaskBtn">ADD TASK</button>
        </div>
        <div id="task-input-box">
          <textarea name="title" id="title" placeholder="Enter title" cols="30" rows="1"></textarea>
          <select name="" id="task-select">
            <option value="">--Select category--</option>
            <option value="ALL TASKS">ALL TASKS</option>
            <option value="IN PROGRESS">IN PROGRESS</option>
            <option value="COMPLETED">COMPLETED</option>
          </select>
          <textarea name="task-details" id="task-details" placeholder="Enter task Details here and click on ADD TASK Button" cols="30" rows="15"></textarea>
        </div>
        <div class="btnDiv">
          <button id="logoutBtn" class="addtaskBtn">LOG OUT</button>
        </div>
      </div>
          <div class="task-category">
            <div class="tasks-header">
              <div>ALL TASKS</div>
              <div class="task-stage-logo">
                <i class="fa-solid fa-list-check"></i>
              </div>
              <div class="add-task-logo">
                <i class="fa-solid fa-circle-plus"></i>
              </div>
            </div>
            <hr />
            <div id="listOfAllTasks"></div>
          </div>
          <div class="task-category">
            <div class="tasks-header">
              <div>IN PROGRESS</div>
              <div class="task-stage-logo">
                <i class="fa-solid fa-rectangle-list"></i>
              </div>
              <div class="add-task-logo">
                <i class="fa-solid fa-circle-plus"></i>
              </div>
            </div>
            <hr />
            <div id = "allTasksInProgress"></div>
          </div>
          <div class="task-category">
            <div class="tasks-header">
              <div>COMPLETED</div>
              <div class="task-stage-logo">
                <i class="fa-solid fa-check-double"></i>
              </div>
              <div class="add-task-logo">
                <i class="fa-solid fa-circle-plus"></i>
              </div>
            </div>
            <hr />
            <div id="alltasksCompeted"></div>
          </div>
      </div>
    </div>

    <script>
      let countTask = 1;
      const listOfAllTasks = document.getElementById("listOfAllTasks");
      const allTasksInProgress = document.getElementById("allTasksInProgress");
      const allTasksCompleted = document.getElementById("alltasksCompeted");
      const addNewTaskBtn = document.querySelector(".addtaskBtn");
      const logoutBtn = document.getElementById("logoutBtn");

      async function addNewTask(){
        const title = document.getElementById("title").value;
        const taskCategory = document.getElementById("task-select").value;
        const taskDetail = document.getElementById("task-details").value;

        if(taskCategory === "" || title === "" || taskDetail === ""){
          alert("please fill all the 3 inputs to add a task!")
          return;
        }
        
        const response = await axios.post("http://localhost:3000/todo", {
          taskId:"task-"+countTask,
          title:title,
          detail:taskDetail,
          category:taskCategory
        });
        
        const newTaskElement = 
                `<div id ='task-${countTask}'  class="single-task">
                <div class="task-heading">${title}</div>
                <hr />
                <div class="task-content">${taskDetail}</div>
                <hr />
                <div class="task-bottom">
                  <div><i onClick = 'editTask("task-${countTask}")' class="fa-solid fa-pen-to-square"></i></div>
                  <div><i onClick = 'deleteTask("task-${countTask}")' class="fa-solid fa-trash-can"></i></div>
                </div>
          </div>`

        countTask++;

        if(taskCategory === "ALL TASKS"){
          listOfAllTasks.innerHTML += newTaskElement
        }else if(taskCategory === "IN PROGRESS"){
          allTasksInProgress.innerHTML += newTaskElement
        }else{
          allTasksCompleted.innerHTML += newTaskElement
        }
        clearInputs();
      }

      addNewTaskBtn.addEventListener("click",addNewTask);

      async function editTask(taskId){
        const editElement = document.getElementById(taskId);
        const editTitle = editElement.querySelector(".task-heading");
        const editDetail = editElement.querySelector(".task-content");
    
        addNewTaskBtn.innerHTML = "UPDATE TASK"

        document.getElementById("title").value = editTitle.innerHTML;
        document.getElementById("task-details").value = editDetail.innerHTML;
        document.getElementById("task-select").value = "";
        addNewTaskBtn.removeEventListener("click", addNewTask); // Removes the 'Add' function
        addNewTaskBtn.addEventListener("click", function() {
        updateTask(taskId);
      }, { once: true });
      }

      async function updateTask(taskId){
        const editElement = document.getElementById(taskId);
        editElement.querySelector(".task-heading").innerHTML = document.getElementById("title").value;
        editElement.querySelector(".task-content").innerHTML = document.getElementById("task-details").value;
        addNewTaskBtn.innerHTML = "ADD TASK"; 
        addNewTaskBtn.removeEventListener("click", updateTask); // Removes the 'Update' function
        addNewTaskBtn.addEventListener("click", addNewTask, { once: true });

        await axios.put(`http://localhost:3000/todo/${taskId}`,{
            title:document.getElementById("title").value,
            detail:document.getElementById("task-details").value
        })
      }

      function clearInputs(){
        document.getElementById("title").value = "";
        document.getElementById("task-details").value = "";
        document.getElementById("task-select").value = "";
      }

      async function deleteTask(taskID){
        console.log("delete clicked");
        await axios.delete(`http://localhost:3000/todo/${taskID}`)
        listOfAllTasks.innerHTML = "";
        allTasksInProgress.innerHTML = "";
        allTasksCompleted.innerHTML = "";
        loggedin();
      } 

      //For auth after landing on todo page
      async function loggedin(){
        let token = localStorage.getItem("token");
        let email = localStorage.getItem("email");
        try {
          let response = await axios.get("http://localhost:3000/me",{
            headers:{
              token:token,
              email:email
            }
          })

          userData = await response.data;
          for(let i = 0; i < userData.length; i++){
            const taskId = userData[i].taskId;
            const title = userData[i].title;
            const detail = userData[i].detail;
            const category = userData[i].category;
            
            const newTaskElement = 
                `<div id ='${taskId}'  class="single-task">
                <div class="task-heading">${title}</div>
                <hr />
                <div class="task-content">${detail}</div>
                <hr />
                <div class="task-bottom">
                  <div><i onClick = "editTask('${taskId}')" class="fa-solid fa-pen-to-square"></i></div>
                  <div><i onClick = "deleteTask('${taskId}')" class="fa-solid fa-trash-can"></i></div>
                </div>
          </div>`
          if(category === "ALL TASKS"){
          listOfAllTasks.innerHTML += newTaskElement
          }else if(category === "IN PROGRESS"){
          allTasksInProgress.innerHTML += newTaskElement
          }else{
          allTasksCompleted.innerHTML += newTaskElement
          }

          }
        } catch (error) {
          console.log(error);
          alert("Not logged in! Redirecting to login page")
          window.location.href = "/signin";
        }
      }

      loggedin();

      function logout(){
        localStorage.removeItem("token");
        window.location.href = "http://localhost:3000/signin";
        console.log("Delete ran");
      }
      logoutBtn.addEventListener("click",logout);
    </script>
  </body>
</html>
